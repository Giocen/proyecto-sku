<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta de SKU</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .borde-verde {
      border: 4px solid #22c55e; /* Color verde cuando el SKU es detectado */
      transition: border 0.3s ease;
    }
    .borde-error {
      border: 4px solid #f87171; /* Color rojo en caso de error */
      transition: border 0.3s ease;
    }

    /* Estilos para el men√∫ */
    .menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      height: 100%;
      background-color: #f3f4f6;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      padding: 20px;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }
    .menu-open {
      transform: translateX(0);
    }
    .menu ul {
      list-style-type: none;
      padding-left: 0;
    }
    .menu ul li {
      margin: 10px 0;
    }
    .menu ul li a {
      text-decoration: none;
      color: #333;
      font-size: 16px;
    }
    .menu-button {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: #f3f4f6;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4">

  <!-- Men√∫ lateral -->
  <div id="menu" class="menu">
    <ul>
      <li><a href="#">Inicio</a></li>
      <li><a href="#">Consulta SKU</a></li>
      <li><a href="#">Reportes</a></li>
      <li><a href="#">Ajustes</a></li>
    </ul>
  </div>

  <!-- Bot√≥n para abrir/cerrar el men√∫ -->
  <button onclick="toggleMenu()" class="menu-button">
    ‚ò∞
  </button>

  <div class="max-w-md mx-auto bg-white shadow-xl rounded-2xl p-6 space-y-4 border border-pink-300">
    <img src="https://i.imgur.com/n66e0SR.png"
         alt="Liverpool Logo"
         class="w-40 mx-auto mb-4">

    <h2 class="text-xl font-bold text-center text-pink-600">Consulta de SKU</h2>

    <label class="block text-sm font-medium text-gray-700">SKU</label>
    <input id="sku" type="text" maxlength="15"
           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:border-pink-400"
           placeholder="Escanea o escribe SKU">

    <div id="scanner-container" class="hidden rounded-lg overflow-hidden transition-all duration-300">
      <div id="qr-reader" style="width: 100%;"></div>
    </div>

    <div class="flex flex-col gap-2">
      <button onclick="consultarSku()" id="btnConsultar"
              class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 rounded-lg transition-all">
        üîç Consultar SKU
      </button>

      <button onclick="iniciarScanner()" id="btnToggleScanner"
              class="bg-gray-100 hover:bg-gray-200 text-pink-700 font-semibold py-2 rounded-lg transition-all border border-pink-400">
        üì∑ Escanear c√≥digo de barras
      </button>
    </div>
  </div>

  <script>
    let html5QrCode;
    let escaneando = false;

    // Funci√≥n para iniciar o detener el esc√°ner
    function iniciarScanner() {
      const scannerContainer = document.getElementById("scanner-container");
      const botonScanner = document.getElementById("btnToggleScanner");

      if (escaneando) {
        // Detener el esc√°ner si ya est√° en ejecuci√≥n
        detenerScanner();
        botonScanner.innerText = "üì∑ Escanear c√≥digo de barras";
        escaneando = false;
        return;
      }

      escaneando = true;
      botonScanner.innerText = "üõë Detener escaneo";
      scannerContainer.classList.remove("hidden");
      scannerContainer.classList.remove("borde-verde", "borde-error");

      // Crear nuevo esc√°ner y configurar
      html5QrCode = new Html5Qrcode("qr-reader");

      const config = {
        fps: 10, // 10 frames per second
        qrbox: { width: 250, height: 250 } // Definir el tama√±o del √°rea de escaneo
      };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        console.error("Error iniciando c√°mara:", err);
        alert("No se pudo iniciar la c√°mara. Verifica permisos y conexi√≥n HTTPS.");
        escaneando = false;
        botonScanner.innerText = "üì∑ Escanear c√≥digo de barras";
      });
    }

    // Callback al escanear un c√≥digo con √©xito
    function onScanSuccess(decodedText, decodedResult) {
      console.log(`C√≥digo detectado: ${decodedText}`);
      document.getElementById("sku").value = decodedText;
      document.getElementById("sku").classList.add("borde-verde");

      // Limpia el borde despu√©s de 1 segundo
      setTimeout(() => {
        document.getElementById("sku").classList.remove("borde-verde");
      }, 1000);

      detenerScanner();  // Detenemos el esc√°ner despu√©s de detectar un c√≥digo
      document.getElementById("btnToggleScanner").innerText = "üì∑ Escanear c√≥digo de barras";
      escaneando = false;

      consultarSku(); // Consultamos el SKU detectado
    }

    // Callback cuando el esc√°ner no logra detectar un c√≥digo
    function onScanFailure(error) {
      console.warn(`Error de escaneo: ${error}`);
    }

    // Funci√≥n para detener el esc√°ner
    function detenerScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear().then(() => {
            console.log("Esc√°ner detenido correctamente.");
            document.getElementById("scanner-container").classList.add("hidden");
          }).catch(err => {
            console.error("Error al limpiar el esc√°ner al detenerlo:", err);
          });
        }).catch(err => {
          console.error("Error al detener el esc√°ner:", err);
        });
      }
    }

    // Funci√≥n para consultar el SKU en el sistema
    function consultarSku() {
      var sku = document.getElementById("sku").value;
      var btnConsultar = document.getElementById("btnConsultar");

      if (!sku) {
        mostrarError("Por favor, ingrese un SKU.");
        document.getElementById("sku").classList.add("borde-error");
        return;
      }

      if (!/^[A-Z0-9]{1,15}$/.test(sku)) {
        mostrarError("El SKU debe ser alfanum√©rico y de hasta 15 caracteres.");
        document.getElementById("sku").classList.add("borde-error");
        return;
      }

      document.getElementById("sku").classList.remove("borde-error");
      mostrarCargando("Buscando informaci√≥n...");

      btnConsultar.disabled = true;
      btnConsultar.classList.add("opacity-50", "cursor-not-allowed");

      google.script.run
        .withSuccessHandler(function(result) {
          mostrarResultado(result);
          btnConsultar.disabled = false;
          btnConsultar.classList.remove("opacity-50", "cursor-not-allowed");
        })
        .withFailureHandler(function(error) {
          mostrarError("Hubo un problema al consultar el SKU.");
          btnConsultar.disabled = false;
          btnConsultar.classList.remove("opacity-50", "cursor-not-allowed");
        })
        .consultarSku(sku);
    }

    // Funci√≥n para mostrar mensaje de error
    function mostrarError(message) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: message,
        confirmButtonText: 'OK'
      });
    }

    // Funci√≥n para mostrar mensaje de cargando
    function mostrarCargando(message) {
      Swal.fire({
        title: message,
        didOpen: () => Swal.showLoading(),
        allowOutsideClick: false
      });
    }

    // Funci√≥n para mostrar el resultado de la consulta
    function mostrarResultado(result) {
      if (result) {
        Swal.fire({
          icon: 'success',
          title: 'Resultado encontrado',
          html: `
            <div><strong></strong><br>${result.descripcion}</div>
            <div><strong>No. de Secci√≥n:</strong> ${result.numero}</div>
            <div><strong>Secci√≥n:</strong> ${result.seccion}</div>
            <div><strong>Cantidad:</strong> ${result.cantidad}</div>
            <div><strong>Ubicaci√≥n:</strong><br>${result.ubicacion}</div>
          `,
          confirmButtonText: 'OK'
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'No encontrado',
          text: 'No se encontr√≥ el SKU o no tiene ubicaciones registradas.',
          confirmButtonText: 'OK'
        });
      }
    }

    // Funci√≥n para abrir/cerrar el men√∫ lateral
    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.classList.toggle("menu-open");
    }

    window.onload = function () {
      const inputSku = document.getElementById("sku");
      inputSku.focus();

      inputSku.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          consultarSku();
        }
      });
    };

  </script>
</body>
</html>